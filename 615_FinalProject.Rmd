---
title: "615 Final Project"
author: "Ningze Zu"
date: "12/7/2018"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(echo = TRUE,out.width="0.9\\linewidth",dev="png",fig.align  = 'center')
pacman::p_load(ggplot2,knitr,arm,data.table,foreign,gridExtra,car,stringr,rstan,zoo)
library(tidyverse)
library(dplyr)
library(leaflet)
library(RColorBrewer)
library(corrplot)
library(ggcorrplot)
library(lattice)
library(plotly)
library(png)
library(scales)
library(graphics)
library(ggmap)
library(leaflet)
library(readr)
library(boot)
library(lme4)
library(ggpubr)
library(benford.analysis)
library(BenfordTests)
#air <- read.csv("air.csv")
#airbnb_se <- air %>% dplyr::filter(state == "WA")
#airbnb_se$Area <- rep("Seattle",nrow(airbnb_se))
#sea <- read.csv("sea.csv")
#se <- sea %>% dplyr::filter(state == "WA")
#nei <- data.frame(se$neighbourhood_group_cleansed)
#airbnb_se$market <-NULL
#airbnb_se <- cbind(airbnb_se,nei)
#colnames(airbnb_se)[colnames(airbnb_se)=="se.neighbourhood_group_cleansed"] <- "neighbourhood"
#airbnb_se_m <- airbnb_se %>% filter(price > 0 & price <= 1000) 
airbnb_se_m <- read.csv("sea_airbnb.csv")
```

##1. Abstract
In this project, I will use benford's law to analysis the distribution of Airbnb listings' price in Seattle. 


Figure 1 below shows the price distribution of Airbnb listings in Seattle. The plot displays a normal distribution but a little right skewness. 

```{r echo=FALSE,message=FALSE}
    ggplot(airbnb_se_m, aes(price, fill = room_type)) + 
      geom_histogram(binwidth = 10) + theme_classic() +   
      scale_fill_brewer(palette = "RdPu") + 
      scale_x_continuous(breaks = seq(0, 1000, by = 200)) + 
      xlab("\nPrice ($)") + ylab("Frequency of Price\n") + 
      ggtitle("Figure 1. Airbnb Price Distribution \n  in Seattle ($0 ~$1000)") + 
      theme(axis.title.x = element_text(face="bold",  size=14), 
            axis.title.y = element_text(face="bold",  size=14),
            plot.title = element_text(size=16, face="bold"),  
            axis.text.x  = element_text(vjust=0.5, size=12)) +
      theme(plot.title = element_text(hjust = 0.5)) 
```

To validate the data against Benford's law, I using the first two digits to analysis 'benford'. The main results and plots of the analysis are shown below: 

In the plots, the original data is in blue, and the expected Benford's distribution is in red. We can see from the first plot that the Airbnb rental price in Seattle do have a tendency to follow the Benford's Law. However, there are also some clear discrepancies.

The print result of the analysis displays the main statistics of the data. We can see that the mean value is close to 0.5. It shows the five largest discrepancies and some results of statistical tests like Chi-squared test as well. The p-value is pretty small, but we cannot focus on p-value only. 

```{r}
bf <- benford(airbnb_se_m$price)
plot(bf)
bf
```

Next, I extract the observations with the largest discrpencies and plot the price  distribution. 
```{r}
suspects <- getSuspects(bf, airbnb_se_m)
suspects
```

```{r echo=FALSE,message=FALSE}
ggplot(suspects, aes(price, fill = room_type)) + 
      geom_histogram(binwidth = 50) + theme_classic() +   
      scale_fill_brewer(palette = "RdPu") + 
      scale_x_continuous(breaks = seq(0, 1000, by = 200)) + 
      xlab("\nPrice ($)") + ylab("Frequency of Price\n") + 
      ggtitle("Figure 2. Airbnb Price Distribution \n  in Seattle ($0 ~$1000)") + 
      theme(axis.title.x = element_text(face="bold",  size=14), 
            axis.title.y = element_text(face="bold",  size=14),
            plot.title = element_text(size=16, face="bold"),  
            axis.text.x  = element_text(vjust=0.5, size=12)) +
      theme(plot.title = element_text(hjust = 0.5)) 
```












```{r}
    airbnb_se_map <- airbnb_se%>% filter(price > 0 & price <= 1000)
    pal <- colorNumeric(
      brewer.pal(11, "PiYG")[(4:1)],
      domain = airbnb_se_map$price
    )
  
    
    leaflet(airbnb_se_map) %>% addTiles() %>%
      addCircles(lng = ~longitude, lat = ~latitude, weight = 1,
                 popup = ~price, radius = 80, 
                 color = ~pal(price), fillOpacity = 1) %>%
      addLegend("bottomright", pal = pal, values = ~(price),
                title = "Price Range",
                labFormat = labelFormat(prefix = "$"),
                opacity = 1
      )
    
    
    pal<- brewer.pal(11, "PiYG")[(4:1)]

    
     leaflet(airbnb_se_map) %>% addTiles() %>%
addMarkers(
  clusterOptions = markerClusterOptions())
```

